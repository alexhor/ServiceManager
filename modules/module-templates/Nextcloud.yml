# DO NOT EDIT --- File generated by ServiceManager --- DO NOT EDIT
# docker-compose file for a Nextcloud installation
services:
  db:
    image: mysql:5.7
    environment:
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    restart: always
    volumes:
      - ./mysql:/var/lib/mysql

  nextcloud:
    image: nextcloud:latest
    depends_on:
      - db
      - redis
    environment:
      MYSQL_HOST: ${DOMAIN_ESCAPED}_db:3306
      MYSQL_USER: nextcloud
      MYSQL_DATABASE: nextcloud
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      NEXTCLOUD_DATA_DIR: /var/www/html/data
      NEXTCLOUD_TRUSTED_DOMAINS: ${DOMAIN}
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: admin
      REDIS_HOST: redis
      #REDIS_HOST_PASSWORD: ${REDIS_PASSWORD}
    networks:
      - default
      - proxy
    restart: always
    volumes:
      - ./nextcloud:/var/www/html
    labels:
      - traefik.enable=true
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}.rule=Host(`${DOMAIN}`)
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}.tls.certresolver=LetsEncrypt

  redis:
    image: redis:latest
    #command: [
    #  "bash", "-c",
    #  '
    #  docker-entrypoint.sh
    #  --appendonly yes
    #  --requirepass "$$(cat $$HOST_PASSWORD)"
    #  '
    #]
    #environment:
    #  HOST_PASSWORD: ${REDIS_PASSWORD}
    expose:
      - "6379"
    restart: always
    volumes:
      - ./redis/data:/data

networks:
  proxy:
    name: proxy
    external: true
